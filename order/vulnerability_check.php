<?php
//GET値の置換
//GETされた値を置換 SQLインジェクション対策
/*function changeGET($str){
        $change_array = array("'","\\",'"','%','','?','&','*','/'
                                                 ,'<','>' ,'!','#','`','(',')','--',',','javascript',':');
        $str = str_replace($change_array,"",$str);
        $str = htmlspecialchars($str);
        return $str;
}

//POST値の置換
//POSTされた値を置換 SQLインジェクション対策
function changePOST($str){
  $ary_han = array(
           '!','"','#','$','%','&',"'",'(',')','*','+',',','/','：',';','<','=','>','?','[',"\\",']','^','`','{','|','}','~'
        );
  $ary_zen = array(
           '！','”','＃','＄','％','＆','’','（','）','＊','＋','，','／',':','；','＜','＝','＞','？','［','￥','］','＾','｀','｛','｜','｝','〜'
        );
  $str = str_replace($ary_han, $ary_zen, $str);

        return $str;
}*/


function changeGET($str){
  if (!get_magic_quotes_gpc()) {
    $str = addslashes($str);
  }
  $change_array = array("'","\\",'"','%','','?','&','*','/'
                                           ,'<','>' ,'!','#','`','(',')','--',',','javascript',':');
  $str = str_replace($change_array,"",$str);
  $str = htmlspecialchars($str);
  return $str;
}

function changePOST($str){
  if (!get_magic_quotes_gpc()) {
    $str = addslashes($str);
  }
  $change_array = array("'","\\",'"','%','','?','&','*'
                                           ,'<','>' ,'!','#','`','(',')',',','javascript');
  $change_array2 = array("’","￥",'”','％','','？','＆','＊'
                                           ,'＜','＞' ,'！','＃',"‘",'（','）','、','ｊａｖａｓｃｒｉｐｔ');  
  $str = str_replace($change_array,$change_array2,$str);
  $str = htmlspecialchars($str);  
  return $str;
}
//REQUEST値の置換
//REQUESTされた値を置換 SQLインジェクション対策
function changeREQUEST($str){
        $change_array = array("'","\\",'"','%','','?','&','*','/'
                                                 ,'<','>' ,'!','#','`','(',')','--',',','javascript',':');
        $str = str_replace($change_array,"",$str);
        $str = htmlspecialchars($str);
        return $str;
}
//脆弱性_問題004_対策001
foreach($_GET as $key => $value){
    if (!strptime($_GET[$key], '%Y/%m/%d')) {
      if(is_array($value)){
        foreach ($value as $key2 => $value2) {
            $_GET[$key][$key2] = changeGET($value2);
        } 
      }else{
        $_GET[$key] = changeGET($value);
      }
  }
}
//脆弱性_問題004_対策002
foreach($_POST as $key => $value){
    if(is_array($value)){
        foreach ($value as $key2 => $value2) {
          if(is_array($value2)){
                  foreach ($value2 as $key3 => $value3) {
                    if (!strptime($value3, '%Y/%m/%d')){
                      $_POST[$key][$key2][$key3] = changePOST($value3);
                    }
                  }
          }else{
            if (!strptime($value2, '%Y/%m/%d')){
              $_POST[$key][$key2] = changePOST($value2);
            }
          }
        } 
    }else{
  if (!strptime($_POST[$key], '%Y/%m/%d')) {
      $_POST[$key] = changePOST($value);
    }
  }
}
//XSS対策
function changeURLtoNORMAL($str){
    if(mb_strrpos($str,"/") > mb_strrpos($str,".php")):
        header("HTTP/1.1 301 Moved Permanentry");
        header("Location:"."https://teix.jp/");
        exit;
    endif;
    $change_array = array("%3E","%3C");
    $str2 = str_replace($change_array,"", $str);
    if($str2!=$str):
        header("HTTP/1.1 301 Moved Permanentry");
        header("Location:"."https://teix.jp/");
        exit;
    endif;
}

//脆弱性_問題005_対策002
changeURLtoNORMAL($_SERVER["HTTP_HOST"] . $_SERVER["REQUEST_URI"]);


//CRSF対策
//トークンをセッションにセット
function setToken(){
    $token = sha1(uniqid(mt_rand(), true));
    $token = session_id();//20190517
    $_SESSION['token'] = $token;
}
//トークンをセッションから取得
function checkToken(){

  $referer = $_SERVER["HTTP_REFERER"];
    //セッションが空か生成したトークンと異なるトークンでPOSTされたときは不正アクセス
   if(empty($_SESSION['token'])|| ( $_SESSION['token'] !== $_POST['token'])){
     //logout処理
  if (isset($_COOKIE["PHPSESSID"])) {
      setcookie("PHPSESSID", '', time() - 1800, '/');
      session_destroy();
  }

  // セッションの初期化
  // session_name(""something"")を使用している場合は特にこれを忘れないように!
  // セッション変数を全て解除する
  $_SESSION = array();

  // セッションを切断するにはセッションクッキーも削除する。
  // Note: セッション情報だけでなくセッションを破壊する。
  if (ini_get("session.use_cookies")) {
      $params = session_get_cookie_params();
      setcookie(session_name(), '', time() - 42000,
          $params["path"], $params["domain"],
          $params["secure"], $params["httponly"]
      );
  }

  // 最終的に、セッションを破壊する
  session_destroy();
  header("HTTP/1.1 301 Moved Permanentry");
  header("Location:"."https://teix.jp/");
  exit;
  }
}


//エスケープ
function h($s){
    return htmlspecialchars($s, ENT_QUOTES, "UTF-8");
}

//tokenのセット
function _getToken(){
    echo '<input type="hidden" name="token" value="'.session_id().'">';
}

//GETでアクセスされたとき
if($_SERVER['REQUEST_METHOD'] != 'POST'){
    setToken();
}
//POSTでアクセスされたとき
else{
    checkToken();
}


?>